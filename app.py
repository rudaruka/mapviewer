# app.py

import streamlit as st
import pandas as pd
import numpy as np

# -----------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ì œëª©
# -----------------------------------------------------
st.set_page_config(
    page_title="ğŸ…¿ï¸ ì‹¤ì‹œê°„ ë¹ˆìë¦¬ ì•Œë¦¼ ì„œë¹„ìŠ¤",
    layout="wide"  # ë„“ì€ í™”ë©´ ë ˆì´ì•„ì›ƒ ì‚¬ìš©
)

st.title("ğŸ…¿ï¸ ìŠ¤ë§ˆíŠ¸ ì£¼ì°¨ ì•ˆë‚´ ì‹œìŠ¤í…œ: ë¹ˆìë¦¬ ì‹¤ì‹œê°„ í™•ì¸!")
st.markdown("""
ì´ ì„œë¹„ìŠ¤ëŠ” ëŒ€í˜• ì£¼ì°¨ì¥/ë§ˆíŠ¸ì˜ ë¹ˆìë¦¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ íŒŒì•…í•˜ì—¬ ìš´ì „ìì—ê²Œ ê°€ì¥ ê°€ê¹Œìš´ ì£¼ì°¨ ê³µê°„ì„ ì•ˆë‚´í•˜ëŠ” í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤.
---
""")

# -----------------------------------------------------
# 2. ê°€ìƒì˜ ì£¼ì°¨ ë°ì´í„° ìƒì„± ë° í˜„í™© ê³„ì‚°
# -----------------------------------------------------

@st.cache_data # ë°ì´í„°ê°€ ìì£¼ ë°”ë€Œì§€ ì•Šìœ¼ë©´ ìºì‹œí•˜ì—¬ ì„±ëŠ¥ ìµœì í™”
def load_parking_data():
    # ğŸŒŸ [A] ì£¼ì°¨ì¥ ìœ„ì¹˜ ê°€ì •: ì„œìš¸ì˜ í•œ ë§ˆíŠ¸ ê·¼ì²˜ ì¢Œí‘œë¥¼ ê°€ì •í•©ë‹ˆë‹¤.
    base_lat = 37.5665  # ìœ„ë„
    base_lon = 126.9780 # ê²½ë„

    # ğŸŒŸ [B] ì´ 500ê°œì˜ ì£¼ì°¨ ê³µê°„ ë°ì´í„° ìƒì„±
    num_spots = 500
    
    # 500ê°œì˜ ì„ì˜ì˜ ìœ„ë„/ê²½ë„ ë°ì´í„° ìƒì„± (ê°€ì • ìœ„ì¹˜ ì£¼ë³€ 0.005ë„ ë²”ìœ„)
    df = pd.DataFrame({
        'lat': np.random.randn(num_spots) * 0.005 + base_lat,
        'lon': np.random.randn(num_spots) * 0.007 + base_lon,
        'spot_id': [f'P-{i+1:03d}' for i in range(num_spots)]
    })
    
    # ğŸŒŸ [C] ë¹ˆìë¦¬/ì£¼ì°¨ ì¤‘ ìƒíƒœ ë¬´ì‘ìœ„ í• ë‹¹
    # 60% í™•ë¥ ë¡œ 'occupied' (ì£¼ì°¨ ì¤‘), 40% í™•ë¥ ë¡œ 'available' (ë¹ˆìë¦¬)
    df['status'] = np.random.choice(
        ['occupied', 'available'], 
        size=num_spots, 
        p=[0.6, 0.4]
    )
    
    # ì§€ë„ì— ì‚¬ìš©í•  ìƒ‰ìƒ ì»¬ëŸ¼ ì¶”ê°€ (Streamlit mapì€ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ì œí•œì , ì´í›„ Folium ì‚¬ìš© ì‹œ ìœ ìš©)
    df['color'] = df['status'].apply(lambda x: [0, 255, 0] if x == 'available' else [255, 0, 0]) # [R, G, B]
    
    return df

# ë°ì´í„° ë¡œë“œ
parking_df = load_parking_data()

# í˜„í™© ê³„ì‚°
total_spots = len(parking_df)
available_spots = len(parking_df[parking_df['status'] == 'available'])

# -----------------------------------------------------
# 3. ë¹ˆìë¦¬ í˜„í™© í‘œì‹œ
# -----------------------------------------------------
col1, col2, col3 = st.columns(3)

with col1:
    st.metric(label="ì´ ì£¼ì°¨ ê³µê°„", value=f"{total_spots}ê°œ")
with col2:
    st.metric(label="í˜„ì¬ ì£¼ì°¨ ì¤‘", value=f"{total_spots - available_spots}ê°œ")
with col3:
    # ğŸŒŸ ê°€ì¥ ì¤‘ìš”í•œ ì •ë³´ ê°•ì¡°
    st.metric(
        label="âœ… ì‹¤ì‹œê°„ ë¹ˆìë¦¬ ìˆ˜", 
        value=f"{available_spots}ê°œ",
        delta=f"{(available_spots / total_spots * 100):.1f}% í™•ë³´"
    )

st.header(f"ğŸš— ê³ ê°ë‹˜! í˜„ì¬ ë§ˆíŠ¸ì˜ ë¹ˆìë¦¬ëŠ” **{available_spots}**ê°œ ì…ë‹ˆë‹¤! ì¾Œì í•˜ê²Œ ì£¼ì°¨í•˜ì„¸ìš”! ğŸ¥³")

# -----------------------------------------------------
# 4. ì§€ë„ ì‹œê°í™”
# -----------------------------------------------------

st.subheader("ğŸ“ ì£¼ì°¨ì¥ ì§€ë„ ë° ë¹ˆìë¦¬ ìœ„ì¹˜")
st.markdown("**(ì´ˆë¡ìƒ‰ ë§ˆì»¤ê°€ ë¹ˆìë¦¬)**")

# ë¹ˆìë¦¬ë§Œ ë”°ë¡œ í•„í„°ë§
available_spots_df = parking_df[parking_df['status'] == 'available']

# Streamlitì˜ ê¸°ë³¸ ì§€ë„ ê¸°ëŠ¥ìœ¼ë¡œ ë¹ˆìë¦¬ ìœ„ì¹˜ í‘œì‹œ
# ì°¸ê³ : Streamlitì˜ ê¸°ë³¸ st.mapì€ ë§ˆì»¤ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ì–´ë µê¸° ë•Œë¬¸ì—,
# ì—¬ê¸°ì„œëŠ” ë¹ˆìë¦¬ì˜ ìœ„ì¹˜ë§Œ í‘œì‹œí•˜ê±°ë‚˜ ëª¨ë“  ìœ„ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
# 
if not available_spots_df.empty:
    st.map(available_spots_df, latitude='lat', longitude='lon', size=15)
else:
    st.warning("í˜„ì¬ ë¹ˆìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì°¨ì¥ì´ ë§Œì°¨ì…ë‹ˆë‹¤.")

# -----------------------------------------------------
# 5. ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ë°˜ ì•ˆë‚´ (ë‹¤ìŒ ë‹¨ê³„ êµ¬í˜„ ì˜ˆì •)
# -----------------------------------------------------
st.subheader("ğŸ” ê°€ê¹Œìš´ ë¹ˆìë¦¬ ì•ˆë‚´ (V2 ê¸°ëŠ¥)")

st.markdown("""
*ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ” ì‚¬ìš©ìê°€ ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ë©´, `available_spots_df`ì˜ ë°ì´í„°ì™€ ë¹„êµí•˜ì—¬ **ê°€ì¥ ê°€ê¹Œìš´ ë¹ˆìë¦¬**ë¥¼ ê³„ì‚°í•˜ê³  ì•ˆë‚´í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•  ì˜ˆì •ì…ë‹ˆë‹¤.*
""")

# --- ì‚¬ì´ë“œë°” ì •ë³´ ---
with st.sidebar:
    st.header("ì•± ì •ë³´")
    st.info("ì´ ì•±ì€ Streamlitê³¼ Pythonìœ¼ë¡œ êµ¬í˜„ëœ ìŠ¤ë§ˆíŠ¸ ì£¼ì°¨ ì•ˆë‚´ í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤.")
    st.markdown("ì½”ë“œ ì¶œì²˜: GitHub ì €ì¥ì†Œ ì—°ê²°")
