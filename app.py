# app.py

import streamlit as st
import pandas as pd
import numpy as np
import time
import random 

# -----------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ì œëª©
# -----------------------------------------------------
st.set_page_config(
    page_title="ğŸ…¿ï¸ ì‹¤ì‹œê°„ ë¹ˆìë¦¬ ì•Œë¦¼ ì„œë¹„ìŠ¤",
    layout="wide"  # ë„“ì€ í™”ë©´ ë ˆì´ì•„ì›ƒ ì‚¬ìš©
)

st.title("ğŸ…¿ï¸ ìŠ¤ë§ˆíŠ¸ ì£¼ì°¨ ì•ˆë‚´ ì‹œìŠ¤í…œ: ë¹ˆìë¦¬ ì‹¤ì‹œê°„ í™•ì¸!")
st.markdown("""
ì´ ì„œë¹„ìŠ¤ëŠ” ëŒ€í˜• ì£¼ì°¨ì¥/ë§ˆíŠ¸ì˜ ë¹ˆìë¦¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ íŒŒì•…í•˜ì—¬ ìš´ì „ìì—ê²Œ ê°€ì¥ ê°€ê¹Œìš´ ì£¼ì°¨ ê³µê°„ì„ ì•ˆë‚´í•˜ëŠ” í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤.
ì‹¤ì œ ì‚¬ìš© ì‹œì—ëŠ” ì£¼ì°¨ì¥ ì„¼ì„œ ë˜ëŠ” CCTV ë¶„ì„ ì‹œìŠ¤í…œì˜ APIë¥¼ ì—°ë™í•˜ê²Œ ë©ë‹ˆë‹¤.
---
""")

# -----------------------------------------------------
# 2. ê°€ìƒì˜ API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜)
# -----------------------------------------------------

def fetch_parking_data_from_api():
    """ê°€ìƒì˜ API í˜¸ì¶œì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ ì£¼ì°¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    
    # ì‹¤ì œ API í˜¸ì¶œ ì‹œ time.sleep() ëŒ€ì‹  requests.get(API_URL) ë“±ì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.
    # time.sleep(0.5) # ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì‹œë®¬ë ˆì´ì…˜ (í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ)

    # ì£¼ì°¨ì¥ ìœ„ì¹˜ ê°€ì •: ì„œìš¸ì˜ í•œ ë§ˆíŠ¸ ê·¼ì²˜ ì¢Œí‘œë¥¼ ê°€ì •í•©ë‹ˆë‹¤.
    base_lat = 37.5665  # ìœ„ë„
    base_lon = 126.9780 # ê²½ë„
    num_spots = 500
    
    # 500ê°œì˜ ì„ì˜ì˜ ìœ„ë„/ê²½ë„ ë°ì´í„° ìƒì„±
    df = pd.DataFrame({
        'lat': np.random.randn(num_spots) * 0.005 + base_lat,
        'lon': np.random.randn(num_spots) * 0.007 + base_lon,
        'spot_id': [f'P-{i+1:03d}' for i in range(num_spots)]
    })
    
    # ë¹ˆìë¦¬ ë¹„ìœ¨ì„ ë§¤ë²ˆ ë‹¤ë¥´ê²Œ í•˜ì—¬ ë³€í™”ë¥¼ ì‹œë®¬ë ˆì´ì…˜ (30% ~ 50% ì‚¬ì´)
    random_available_rate = random.uniform(0.3, 0.5) 
    df['status'] = np.random.choice(
        ['occupied', 'available'], 
        size=num_spots, 
        p=[1 - random_available_rate, random_available_rate]
    )
    
    return df

# -----------------------------------------------------
# 3. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì»¨í…Œì´ë„ˆ ì„¤ì • ë° ë£¨í”„ ì‹œì‘
# -----------------------------------------------------

# st.empty()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ê³ , ì´ ì»¨í…Œì´ë„ˆì˜ ë‚´ìš©ë§Œ ê³„ì† ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
# ì´ë¡œ ì¸í•´ í˜ì´ì§€ ì „ì²´ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•Šê³ ë„ ì¼ë¶€ ì˜ì—­ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ ë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.
realtime_container = st.empty()

while True: # ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©° ê³„ì† ì—…ë°ì´íŠ¸
    with realtime_container.container():
        
        # 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜)
        parking_df = fetch_parking_data_from_api()
        
        # 2. í˜„í™© ê³„ì‚°
        total_spots = len(parking_df)
        available_spots = len(parking_df[parking_df['status'] == 'available'])
        
        # 3. Streamlit ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸
        st.subheader(f"âœ… ë°ì´í„° ê°±ì‹  ì‹œê°„: {time.strftime('%H:%M:%S')}")
        
        # í˜„í™© ë©”íŠ¸ë¦­ í‘œì‹œ
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric(label="ì´ ì£¼ì°¨ ê³µê°„", value=f"{total_spots}ê°œ")
        with col2:
            st.metric(label="í˜„ì¬ ì£¼ì°¨ ì¤‘", value=f"{total_spots - available_spots}ê°œ")
        with col3:
            st.metric(
                label="âœ… ì‹¤ì‹œê°„ ë¹ˆìë¦¬ ìˆ˜", 
                value=f"{available_spots}ê°œ",
                delta=f"{(available_spots / total_spots * 100):.1f}% í™•ë³´"
            )

        # í…ìŠ¤íŠ¸ ì•Œë¦¼
        st.header(f"ğŸš— ê³ ê°ë‹˜! í˜„ì¬ ë§ˆíŠ¸ì˜ ë¹ˆìë¦¬ëŠ” **{available_spots}**ê°œ ì…ë‹ˆë‹¤! ğŸ¥³")

        # 4. ì§€ë„ ì‹œê°í™” ì—…ë°ì´íŠ¸
        st.subheader("ğŸ“ ì£¼ì°¨ì¥ ì§€ë„ ë° ë¹ˆìë¦¬ ìœ„ì¹˜")
        st.markdown("**(ì´ˆë¡ìƒ‰ ë§ˆì»¤ê°€ ë¹ˆìë¦¬, ë¹¨ê°„ìƒ‰ ë§ˆì»¤ëŠ” ì£¼ì°¨ ì¤‘ì¸ ìë¦¬)**")
        
        # Streamlit st.mapì€ ë§ˆì»¤ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ì œí•œì ì…ë‹ˆë‹¤. 
        # ì„ì˜ë¡œ ëª¨ë“  ì£¼ì°¨ ê³µê°„ì˜ ì¢Œí‘œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        
        # ë¹ˆìë¦¬ë¥¼ ê°•ì¡°í•˜ê¸° ìœ„í•´ ë¹ˆìë¦¬ ë°ì´í„°ë§Œ ë”°ë¡œ í•„í„°ë§
        available_spots_df = parking_df[parking_df['status'] == 'available']

        if not available_spots_df.empty:
            st.map(available_spots_df, latitude='lat', longitude='lon', size=15)
        else:
            st.warning("í˜„ì¬ ë¹ˆìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì°¨ì¥ì´ ë§Œì°¨ì…ë‹ˆë‹¤.")

        # 5. ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ë°˜ ì•ˆë‚´ (ë‹¤ìŒ ë‹¨ê³„ êµ¬í˜„ ì˜ˆì •)
        st.subheader("ğŸ” ê°€ê¹Œìš´ ë¹ˆìë¦¬ ì•ˆë‚´ (V2 ê¸°ëŠ¥)")
        st.markdown("ì‚¬ìš©ìì˜ ìœ„ì¹˜ë¥¼ ë¶„ì„í•´ ìµœë‹¨ ê±°ë¦¬ì˜ ë¹ˆìë¦¬ë¥¼ ì°¾ì•„ ì•ˆë‚´í•˜ëŠ” ê¸°ëŠ¥ì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.")
        
    # 6. ë‹¤ìŒ ì—…ë°ì´íŠ¸ê¹Œì§€ ì ì‹œ ëŒ€ê¸°
    # 5ì´ˆë§ˆë‹¤ ë£¨í”„ê°€ ë‹¤ì‹œ ì‹¤í–‰ë˜ì–´ fetch_parking_data_from_api()ë¥¼ í˜¸ì¶œí•˜ê³  í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
    time.sleep(5)
